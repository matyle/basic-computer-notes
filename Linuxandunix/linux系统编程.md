### 第二章 基本概念

#### 操作系统核心----内核
##### 2.1 操作系统
- 操作系统
  - 完整软件包
  - 狭义：管理和分配计算机资源（cpu，ram和设备）（内核）
  - 没有内核 计算机也能运行程序，但是有内核可以极大简化


- 内核职责
  - 进程调度：Linux属于抢占式
  - 内存管理
    - 虚拟内存（6.4节）：
      - 进程与进程之间，进程与内核之间彼此隔离
      - 只需进程的一部分保持在内存中
  - 文件系统：
  - 创建和终止进程
  - 设备访问
  - 联网
  - 提供系统调用应用编程接口


- 内核态与用户态
  - 硬件指令可使cpu在两种状态来回切换
  - 可将虚拟内存划分或标记为用户空间或内核空间


##### 2.2 shell 命令解释器
- 读取用户输入的命令并执行
- sh,bash,csh 


##### 2.3 用户和组
- 用户
  - 用户名和UID，组ID，主目录，登录shell
- 组
- 超级用户

##### 2.4 单根目录层级，目录，链接及文件
- 链接
  - 硬链接即 普通链接 
  - 软链接（符号链接） 快捷方式
##### 2.5 文件IO模型
- 采用系统调用处理文件，内核只提供一种字节流序列
- `lseek()`系统调用随机访问
- io系统调用使用文件描述符
##### 2.6 程序

`int main(int argc,char *argv[])`

##### 2.7 进程
- 进程是正在执行的程序实例，执行程序时
  - 内核将程序代码载入虚拟内存
  - 为程序变量分配空间，建立内核bookkeeping数据结构，记录进程相关信息，如进程id，用户id，组id等
  - 内核必须在进程间共享计算机资源，并统筹资源

- 进程的内存布局
  - 进程分为几个部分（段）
    - 文本段：程序指令
    - 数据段：程序使用的静态变量
    - 堆段：动态分配额外内存（c++ new）
    - 栈段：随函数调用，返回而递减的一片内存，用于存储局部变量等。（栈是从下往上分配，地址越往上越小）
- 创建进程和执行程序
  - fork()创建新进程，调用fork()的进程为父进程，新创建的进程为子进程
  - 子进程要么与父进程共享代码段去执行另外的函数，要么使用系统调用execve()去加载全新程序，同时摧毁上面几个段。
- init进程：所有进程之父
- 守护进程：
- 环境变量
- 资源限制 setrlimit()

##### 2.8 内存映射

- 文件映射：文件部分区域映射到虚拟内存
- 某一进程映射内存可以与其他进程共享
  - 其一两个进程针对某一文件的相同部分进行映射
  - fork()创建的子进程与父进程处继承映射

##### 2.9 静态库和共享库
- 静态库：静态链接-将静态库中的需要的目标模块赋值到可执行文件中 -浪费内存，和磁盘空间；同时如果库函数有修改，需要重新编译生产静态库
- 共享库：不会复制，只会在可执行文件中写入一条记录，记录需要使用共享库。通过动态链接器，运行时载入动态库


##### 2.10 进程间通信及同步
多个进程运行，有些进程需要相互合作。因此需要通信和同步
- 进程间通信机制IPC
  - `信号signal：用来表示事件的发生`
  - `管道`：shell中“｜”操作符和`FIFO`,用于在进程之间传递数据
  - `套接字(socket)`：一台主机或是联网的不同主机运行的进程之间的通信
  - `文件锁定`：mutex lock为了防止其他进程读取或者更新文件内容，允许某进程锁定文件的部分区域
  - `消息队列`：进程间利用队列交换消息
  - `信号量(semaphore)`：同步进程动作
  - `共享内存`：两个进程共享一块内存，若有其一改变内存内容，其他所有程序都会立即了解到这一变化
  
##### 2.11 信号
信号称为“**软件中断**”，进程收到信号=某一事件或者异常发生，用整数标识不同信号类型
- 内核，其他进程（要有相应权限）或进程自身均可向进程发送信号

##### 2.12 线程
每个进程都可以执行多个线程
- 线程共享同一数据段和堆段，每个线程有自己的栈，用来装载本地变量和函数调用链接信息
- 线程可通过共享的全局变量进行通信
- 进程与线程之间的区别
  - 进程是系统进行资源调度和分配的基本单位，线程是程序执行的基本单位
  - 进程有自己的资源空间
  - 一个进程可以包含若干个线程。

##### 2.17 客户端/服务器架构


##### 2.18 实时性
扩展：异步I/O，共享内存，内存映射文件，内存锁定


### 第三章 系统编程概念

#### 3.1 系统调用
- 系统调用将处理器从用户态切换到核心态
- 系统调用顺序
  1. 调用c语言中的外壳函数
  2. 传入系统调用参数，将参数置入特定寄存器
  3. 将调用编号存入特殊cpu寄存器中
  4. 外壳函数执行中断指令(`int 0x80`)
  5. 响应中断指令，调用system_call()
  6. 