redis怎么实现的？ c语言

## SDS的定义

```c
struct sdshdr
{
  int len;
  int free; //未使用空间
  char buf[]; //实际存的数据 包含空字符（但是不算len） 字节数组
};
```



未使用空间有啥作用？

为啥叫字节数组？

## SDS与C字符串的区别

核心是c字符串不记录自身长度

### 获取字符串长度



### 杜绝缓冲区溢出

`sdscat`函数

自动扩展空间，那么如何扩展呢？是刚好分配需要的吗？

分配方法：预分配

### 减少字符串修改内存重分配次数

核心：预分配和惰性空间释放

为什么预分配？





#### 预分配

分配条件：

剩余空间free不足，即小于需要占用空间

修改之后的长度len（注意这个len不包含空字符）

1. len<1MB
2. len>=1MB

####  惰性空间释放 free的作用出来了

sdstrim删除sds中的c字符串出现的字符

`sdstrim(s,"xy")`删除sds字符串中所有的xy

但是这里的删除并不是真正的删除，后期可以直接使用不需要分配





### 二进制安全

什么是二进制安全？

二进制文件vs文本文件

buf为什么称之为字节数组？因为它不是用这个存字符，而是一些列二进制文件

但是兼容c字符串，以len为结尾，如果是c语言中空字符串结束符不算len，而不是结束符的'\0'算len（有点绕，总体来说以len结尾为准）

## SDS API

## 总结

SDS结构体对c字符串的封装有啥好处？

不仅仅是简单的封装，多了两个参数竟然这么有用

len,free,buf三者配合

获取长度

防止缓冲区溢出 类似readn

减少内存分配次数

达到二进制安全（与c字符串最大的不同）

兼容C字符串

