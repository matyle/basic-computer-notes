## 事务

- 开始一个事务：begin
- 事务的概念：简单来说，事务就是要保证一组数据库操作，要么全部成功，要么全部失败。在 MySQL 中，事务支持是在引擎层实现的
- 特性：肯定会想到 ACID（Atomicity、Consistency、Isolation、Durability，即原子性、一致性、隔离性、持久性）
    - 原子性（Atomicity）
    - 一致性（consistency）
    - 隔离性 (isolation)
    - 持久性（durability）redo-log是核心

### 隔离性 

- 多个事务同时读写，可能出现：**脏读，不可重复读，幻读**
  - 脏读:读到其他事务未提交的数据； 
  - 不可重复读：前后读取的记录内容不一致； 
  - 幻读：前后读取的记录数量不一致。


- SQL 标准的事务隔离级别包括：
  - **读未提交（read uncommitted）**
    - 一个事务还没提交时，它做的变更就能被别的事务看到。
  - **读提交（read committed）**
    - 一个事务提交之后，它做的变更才会被其他事务看到。
  - **可重复读（repeatable read）**（mysql默认）
    - 一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的（即别人对事务的修改且它提交了我也不可见）
    - 如果是我自己改自己查当然能看到改
  - **串行化**（serializable ）读写锁
    - 顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。
  
  - **读未提交：**别人改数据的事务尚未提交，我在我的事务中也能读到。
  -  **读已提交：**别人改数据的事务已经提交，我在我的事务中才能读到。
  -  **可重复读：**别人改数据的事务已经提交，我在我的事务中也不去读。
  - **串行：**我的事务尚未提交，别人就别想改数据。
这4种隔离级别，并行性能依次降低，安全性依次提高。
```sql

create table t(c int) engine=InnoDB;
insert into t(c) values(1);

show variables like'transaction_isolation';
```


- 实现：
  - 数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。
  - 在“可重复读”隔离级别下，这个视图是在事务启动时创建的，整个事务存在期间都用这个视图。
  - 在“读提交”隔离级别下，这个视图是在每个 SQL 语句开始执行的时候创建的。
  - 这里需要注意的是，**“读未提交”隔离级别下直接返回记录上的最新值，没有视图概念；**
  - 而“串行化”隔离级别下直接用加锁的方式来避免并行访问。


### 事务隔离的实现
- 可重复读实现
- 在 MySQL 中，实际上每条记录在更新的时候都会同时记录一条回滚操作。记录上的最新值，通过回滚操作，都可以得到前一个状态的值。
- 从 1 被按顺序改成了 2、3、4，在回滚日志里面就会有类似下面的记录。
  <center>
      <img style="border-radius: 1.125em;
      box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);"
      src=img/2021-07-16-14-59-41.png
  width=450px>
  </center>

  - 当前值是 4，但是在查询这条记录的时候，不同时刻启动的事务会有不同的 read-view。

- 在不需要的时候才删除。也就是说，系统会判断，当没有事务再需要用到这些回滚日志时，回滚日志会被删除
  - 当系统里没有比这个回滚日志更早的 read-view 的时候。

- 尽量不要使用长事务。


### 事务的启动方式

- 显式启动事务语句， begin 或 start transaction。配套的提交语句是 commit，回滚语句是 rollback。
- set autocommit=0，这个命令会将这个线程的自动提交关掉。意味着如果你只执行一个 select 语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接。

- 建议你总是使用 set autocommit=1, 通过显式语句的方式来启动事务。

- 查询事务：`select * from information_schema.innodb_trx;`