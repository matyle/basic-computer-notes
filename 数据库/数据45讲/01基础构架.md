- 看一个事儿千万不要直接陷入细节里，你应该先鸟瞰其全貌，这样能够帮助你从高维度理解问题。


## Mysql基础架构
```sql
mysql> select * from T where ID=10；
```
<center>
    <img style="border-radius: 1.125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);"
    src=img/2021-07-15-15-42-26.png
width=450px>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">MySQL 的逻辑架构图</div>
</center>

mysql分为Server层和存储引擎层

### Server层
- Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。
- 连接器：管理链接，权限验证
  -  `mysql -h$ip -P$port -u$user -p` 连接命令
  - 如果用户名或密码不对，你就会收到一个"Access denied for user"的错误，然后客户端程序结束执行
  - 如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。
- 查询缓存 已无
  - 之前执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中.
  - 为什么查询缓存往往弊大于利?。
    - 1.容易失效，对表更新即清空。除非是静态表，否则查询缓存效果不大
    - MySQL 8.0 版本直接将查询缓存的整块功能删掉了
- **分析器**（**要做什么**）：词法分析，语法分析
  - 分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。
  - 比如识别关键字select,insert into等，识别字符，列名等
  - 做完了这些识别以后，就要做**语法分析**。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法（如列不存在，语法错误应该都是分析器阶段的。）
  - **一般语法错误会提示第一个出现错误的位置，所以你要关注的是紧接“use near”的内容。**
- 优化器（**知道怎么做还不够，怎么做的更好**）：执行计划生成，索引选择
  - 经过了分析器，MySQL 就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。
  - **优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。**
- **执行器** 操作引擎，返回结果
  - MySQL 通过分析器知道了你要做什么，通过优化器知道了该怎么做
  - 验证访问权限，没有权限会返回没有权限的错误提示。（在分析器之后，知道要“干什么”之后，也会先做一次权限验证。叫做precheck。而precheck是无法对运行时涉及到的表进行权限验证的，比如使用了触发器的情况。因此在执行器这里也要做一次执行时的权限验证。）
  - 验证通过之后，打开表执行器就会根据表的引擎定义，去使用这个引擎提供的接口。
  - 执行器的流程
  ```sql
  
    mysql> select * from T where ID=10;
  
    ERROR 1142 (42000): SELECT command denied to user 'b'@'localhost' for table 'T'
  ```
  - 调用InnoDB引擎接口取这个表的第一行(**注意此时是从InnoDB引擎中读行，并不是InnoDB引擎从磁盘读页**），判断 ID 值是不是 10，如果不是则跳过，如果是则将这行存在结果集中；
  - 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。
  - 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。
- **对于有索引的表，与上类似**：第一次调用的是“取满足条件的第一行”这个接口，之后循环取“满足条件的下一行”这个接口，这些接口都是引擎中已经定义好的。
- 表的字段不是数据，是事先定义好的，所以可以直接读取的，不需要打开表

- 问题3：权限查询可能虽然在最后，但是一定是在给用户返回结果之前！！且可能是precheck（在分析器之后）
### 存储引擎层
- 现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5.5 版本开始成为了默认存储引擎。

  