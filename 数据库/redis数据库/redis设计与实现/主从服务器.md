# 主从复制

## 实现

slaveof host port 使服务器成为某个服务器的从服务器

slave no one 独立



## 旧版复制功能实现

同步和命令传播

同步：将从服务器状态更新至主服务器当前所处的数据库状态

命令传播：主服务器数据库状态被修改



### 同步

1. 从服务器发送sync命令至主服务器
2. 收到sync命令的主服务器，开始执行bgsave（生成rdb文件），并使用缓冲区记录从现在开始执行的所有写命令
3. bgsave完成后主服务器发送rdb文件，从服务器载入，使得恢复到主服务器执行bgsave时的状态
4. 载入完成后，将主服务器缓存的写命令发送给从服务器



### 命令传播

每当主服务器客户端发送修改命令，主服务器修改之后，若从服务器没有修改，则会导致不一致

主服务器对从服务器





## 新版复制功能

PSYNC两种模式：

完整重同步  类似于sync

部分重同步：适用于断线后的情况，重新同步部分数据（仅不一致的数据）



如何实现部分重同步：

1. 主服务器复制偏移量
2. 复制积压缓冲区
3. 服务器运行ID



### 复制偏移量



### 复制积压缓冲区

固定大小的先进先出队列FIFO，当超过长度，最先进的数据出队

若

### 服务器运行ID





## 复制的实现

1. 从服务器与主服务器建立套接字连接 （从服务器相当于客户端）
2. 从服务器设置事件处理函数，用于接收主服务器的RDB，以及写命令
3. 发送PING命令
4. 身份验证
5. 发送端口信息（只是为了打印从服务器端口号）
6. 同步
7. 命令传播

## 心跳检测

从服务器每秒一次发送命令

```sh
REPLCONF ACK <replication_offset>
```

长短连接

